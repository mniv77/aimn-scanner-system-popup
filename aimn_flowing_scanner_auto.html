<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AIMn Flowing Scanner Dashboard - AUTO MODE</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes scroll {0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}
    @keyframes scroll-reverse {0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
    .animate-scroll{animation:scroll 80s linear infinite}
    .animate-scroll-reverse{animation:scroll-reverse 60s linear infinite}
    @keyframes scanPulse {0%,100%{box-shadow:0 0 0 0 rgba(59,130,246,.7);transform:scale(1)}50%{box-shadow:0 0 0 10px rgba(59,130,246,0);transform:scale(1.02)}}
    @keyframes scanGlow {0%,100%{border-color:#3b82f6;background:linear-gradient(90deg,rgba(59,130,246,.1) 0%,rgba(59,130,246,.2) 50%,rgba(59,130,246,.1) 100%)}50%{border-color:#60a5fa;background:linear-gradient(90deg,rgba(96,165,250,.2) 0%,rgba(96,165,250,.3) 50%,rgba(96,165,250,.2) 100%)}}
    @keyframes scannerBeam {0%{left:-100%}100%{left:100%}}
    .row-testing{animation:scanPulse 2s infinite,scanGlow 3s infinite;border:2px solid #3b82f6!important;position:relative;overflow:hidden;background:linear-gradient(90deg,rgba(59,130,246,.15) 0%,rgba(59,130,246,.25) 50%,rgba(59,130,246,.15) 100%);z-index:10}
    .row-testing::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent 0%,rgba(255,255,255,.3) 50%,transparent 100%);animation:scannerBeam 2s infinite;z-index:1}
    .row-testing::after{content:'AUTO-TRADING...';position:absolute;top:2px;right:2px;background:#3b82f6;color:#fff;padding:2px 6px;border-radius:3px;font-size:10px;font-weight:bold;z-index:2;animation:pulse 1s infinite}
    .broker-available{background:rgba(0,128,0,.2);border-color:#10b981}
    .broker-busy{background:rgba(255,140,0,.2);border-color:#f59e0b}
    .symbol-available{background:rgba(0,200,0,.15);border-left:4px solid #10b981}
    .symbol-busy-active{background:rgba(220,38,38,.2);border-left:4px solid #dc2626}
    .symbol-busy-blocked{background:rgba(120,53,15,.2);border-left:4px solid #92400e}
    .ticker-available{background:#065f46;border:1px solid #10b981;color:#d1fae5}
    .ticker-active-trade{background:#7f1d1d;border:1px solid #dc2626;color:#fecaca}
    .ticker-blocked{background:#451a03;border:1px solid #92400e;color:#fcd34d;opacity:.85}
  </style>
</head>
<body class="bg-gray-900 text-white">
  <div class="p-4 mb-4">
    <h1 class="text-3xl font-bold text-center mb-2">ü§ñ AIMn Auto-Trading Scanner</h1>
    <p class="text-center text-gray-400">Fully Automated Multi-Exchange Market Scanning & Trading</p>
    <p class="text-center text-xs text-green-400 mt-1">‚ö° AUTO MODE - Trades execute automatically when signals detected</p>

    <!-- Controls -->
    <div class="mt-4 max-w-5xl mx-auto bg-gray-800 rounded-lg p-3">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div>
          <label class="text-xs text-gray-400">Mode</label>
          <select id="mode" class="w-full bg-gray-700 text-white p-2 rounded">
            <option value="aggressive">Aggressive (more signals)</option>
            <option value="balanced" selected>Balanced</option>
            <option value="conservative">Conservative (fewer signals)</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-gray-400">RSI Type</label>
          <select id="rsi-type" class="w-full bg-gray-700 text-white p-2 rounded">
            <option value="real" selected>RSIReal (price-level)</option>
            <option value="wilder">RSI Wilder</option>
          </select>
        </div>
        <div class="flex items-end gap-3">
          <label class="inline-flex items-center gap-2 text-sm"><input id="f-macd" type="checkbox" class="accent-blue-500" checked/> MACD</label>
          <label class="inline-flex items-center gap-2 text-sm"><input id="f-vol"  type="checkbox" class="accent-blue-500"/> Volume</label>
          <label class="inline-flex items-center gap-2 text-sm"><input id="f-atr"  type="checkbox" class="accent-blue-500"/> ATR</label>
          <button id="apply-controls" class="ml-auto bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded text-sm font-semibold">Apply</button>
        </div>
      </div>
      <div class="text-xs text-gray-400 mt-2">Tip: Aggressive + RSIReal + fewer filters ‚áí more trades.</div>
    </div>

    <!-- Manual Test -->
    <div class="text-center mt-4">
      <div class="flex justify-center gap-4">
        <button onclick="openTradePopupTestStock()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold shadow-lg transition-all">
          üìä Manual Test - Stock (AAPL)
        </button>
        <button onclick="openTradePopupTestCrypto()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold shadow-lg transition-all">
          ‚Çø Manual Test - Crypto (BTC)
        </button>
      </div>
      <p class="text-gray-500 text-sm mt-2">Manual tests open popup without auto-trade | Scanner runs auto-trade mode</p>
      <div class="inline-flex items-center space-x-2 bg-blue-600 px-4 py-2 rounded-lg mt-3">
        <div class="w-3 h-3 bg-white rounded-full animate-pulse"></div>
        <span class="text-sm font-semibold">Currently Testing: <span id="current-testing-symbol" class="font-mono">--</span></span>
      </div>
    </div>
  </div>

  <!-- Broker Status -->
  <div class="mx-4 mb-4 bg-gray-800 rounded-lg p-4">
    <h2 class="text-xl font-semibold mb-3">Broker Status</h2>
    <div id="exchange-status" class="grid grid-cols-1 md:grid-cols-5 gap-4"></div>
  </div>

  <!-- Tickers -->
  <div class="mb-4 bg-black border-y border-gray-700">
    <div class="relative overflow-hidden py-3">
      <div id="main-ticker" class="flex animate-scroll whitespace-nowrap"></div>
    </div>
    <div class="space-y-1">
      <div class="relative overflow-hidden bg-gray-900 py-2">
        <div id="flow-1" class="flex animate-scroll-reverse whitespace-nowrap"></div>
      </div>
      <div class="relative overflow-hidden bg-gray-900 py-2">
        <div id="flow-2" class="flex animate-scroll whitespace-nowrap"></div>
      </div>
    </div>
  </div>

  <!-- Grid -->
  <div class="mx-4 bg-gray-800 rounded-lg p-4">
    <div class="flex justify-between items-center mb-3">
      <h2 class="text-xl font-semibold">Detailed Scan Results</h2>
      <div class="flex items-center space-x-2 text-sm">
        <div class="w-3 h-3 bg-blue-500 rounded animate-pulse"></div>
        <span class="text-gray-400">Row <span id="testing-row-number">-</span> Currently Being Analyzed</span>
      </div>
    </div>
    <div class="overflow-hidden">
      <div class="grid grid-cols-10 gap-2 text-sm font-semibold text-gray-400 mb-2 px-2">
        <div>Broker</div><div>Symbol</div><div>Status</div><div>Price</div><div>Change</div>
        <div>Volume</div><div>RSI</div><div>MACD</div><div>Signal</div><div>Action</div>
      </div>
      <div id="scan-results" class="max-h-96 overflow-y-auto space-y-1"></div>
    </div>
  </div>

  <div class="m-4 text-center">
    <a href="/" class="inline-block bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300">‚Üê Back to Dashboard</a>
  </div>

  <script>
    // ----------------- State -----------------
    let exchanges = {}, scanData = [], tickerItems = [];
    let testingRowIndex = 3; // 4th row
    let activeTradeSymbol = null, activeTradeExchange = null;

    // Controls
    function getControls() {
      return {
        mode: document.getElementById('mode').value,               // aggressive|balanced|conservative
        rsiType: document.getElementById('rsi-type').value,        // real|wilder
        useMACD: document.getElementById('f-macd').checked,
        useVOL: document.getElementById('f-vol').checked,
        useATR: document.getElementById('f-atr').checked
      };
    }

    // ----------------- Init -----------------
    function init() {
      generateSampleExchangeData();
      generateSampleScanData();
      generateSampleTickerData();
      updateExchangeStatus();
      updateTickerDisplay();
      updateScanResultsDisplay();

      // Rotation
      setInterval(conveyorBeltRotate, 4000);

      // Periodic status refresh
      setInterval(() => {
        updateExchangeStatus();
        updateTickerDisplay();
      }, 5000);

      // Simulate ticker micro-moves
      setInterval(() => {
        if (!tickerItems.length) return;
        tickerItems.forEach(item => {
          item.price = (parseFloat(item.price) + (Math.random()-0.5)*2).toFixed(2);
          item.change = ((Math.random()-0.5)*10).toFixed(2);
        });
        updateTickerDisplay();
      }, 1500);

      document.getElementById('apply-controls').addEventListener('click', () => {
        generateSampleScanData();
        updateScanResultsDisplay();
      });
    }

    // ----------------- Rotation -----------------
    function conveyorBeltRotate() {
      if (!scanData.length) return;
      const first = scanData.shift();
      scanData.push(first);
      updateScanResultsDisplay();
      checkAndOpenPopups();
    }

    // ----------------- Displays -----------------
    function updateScanResultsDisplay() {
      const container = document.getElementById('scan-results');
      if (!container) return;
      container.innerHTML = '';

      scanData.forEach((row, index) => {
        const isTestingRow = (index === testingRowIndex);

        let statusClass = '', statusText = '';
        if (isTestingRow) {
          statusClass = 'row-testing'; statusText = 'üîç TESTING';
        } else if (row.symbol === activeTradeSymbol) {
          statusClass = 'symbol-busy-active'; statusText = 'üî¥ TRADING';
        } else if (activeTradeExchange && row.exchange === activeTradeExchange) {
          statusClass = 'symbol-busy-blocked'; statusText = 'üü§ BLOCKED';
        } else {
          statusClass = 'symbol-available'; statusText = 'üü¢ AVAILABLE';
        }

        const div = document.createElement('div');
        div.className = `grid grid-cols-10 gap-2 p-2 mb-1 rounded ${statusClass} text-sm items-center`;
        div.innerHTML = `
          <div class="font-semibold">${row.exchange}</div>
          <div class="font-mono font-bold ${isTestingRow ? 'text-xl' : ''}">${row.symbol}</div>
          <div class="text-xs font-semibold">${statusText}</div>
          <div>$${row.price}</div>
          <div class="${parseFloat(row.change)>=0 ? 'text-green-400':'text-red-400'}">${row.change}%</div>
          <div class="text-xs">${row.volume}</div>
          <div class="${row.rsiColor}">${row.rsi}</div>
          <div class="${row.macd>0?'text-green-300':'text-red-300'}">${row.macd.toFixed(2)}</div>
          <div class="font-semibold ${row.signal==='BUY'?'text-green-400':row.signal==='SELL'?'text-red-400':'text-gray-400'}">${row.signal}</div>
          <div class="text-xs">${isTestingRow?'üéØ ANALYZING': row.signal!=='NEUTRAL' ? 'üìä SIGNAL':'‚è∏Ô∏è WAITING'}</div>
        `;
        container.appendChild(div);
      });

      if (scanData[testingRowIndex]) {
        document.getElementById('current-testing-symbol').textContent = scanData[testingRowIndex].symbol;
        document.getElementById('testing-row-number').textContent = testingRowIndex + 1;
      }
    }

    function updateExchangeStatus() {
      fetch('/api/exchange-status')
        .then(r => r.json())
        .then(data => { exchanges = data; updateExchangeStatusDisplay(); })
        .catch(() => { updateExchangeStatusDisplay(); });
    }

    function updateExchangeStatusDisplay() {
      const container = document.getElementById('exchange-status');
      container.innerHTML = '';
      const names = Object.keys(exchanges).length ? Object.keys(exchanges) : Object.keys(sampleExchanges());
      names.forEach(name => {
        const info = exchanges[name] || { symbolCount: 100, scanning: true };
        const isAvailable = !activeTradeExchange || activeTradeExchange !== name;
        const statusClass = isAvailable ? 'broker-available' : 'broker-busy';
        const div = document.createElement('div');
        div.className = `${statusClass} border-2 rounded-lg p-3 transition-all duration-500`;
        div.innerHTML = `
          <div class="font-bold text-lg">${name}</div>
          <div class="text-sm mt-1">${info.symbolCount||'‚Äî'} symbols</div>
          <div class="text-xs mt-2 ${isAvailable ? 'text-green-300':'text-orange-300'}">
            ${isAvailable ? 'üü¢ AVAILABLE' : 'üî¥ TRADING: ' + (activeTradeSymbol||'')}
          </div>`;
        container.appendChild(div);
      });
    }

    function updateTickerDisplay() {
      ['main-ticker', 'flow-1', 'flow-2'].forEach(id => {
        const c = document.getElementById(id); if (!c) return;
        c.innerHTML = '';
        tickerItems.forEach(item => {
          let cls = 'ticker-available';
          if (item.symbol === activeTradeSymbol) cls = 'ticker-active-trade';
          else if (activeTradeExchange && item.exchange === activeTradeExchange) cls = 'ticker-blocked';
          const div = document.createElement('div');
          div.className = `${cls} px-4 py-2 mx-2 rounded inline-block transition-colors duration-500`;
          div.innerHTML = `<span class="font-mono font-semibold">${item.symbol}</span>
            <span class="ml-2">$${item.price}</span>
            <span class="ml-2 ${parseFloat(item.change)>=0?'text-green-300':'text-red-300'}">${item.change}%</span>
            ${item.signal && item.signal!=='NEUTRAL' ? `<span class="ml-1 text-xs ${item.signal==='BUY'?'text-green-300':'text-red-300'}">${item.signal}</span>`:''}`;
          c.appendChild(div);
        });
      });
    }

    // ----------------- Data -----------------
    function sampleExchanges() {
      return {
        'ALPACA': { scanning: true, symbolCount: 250 },
        'CRYPTO': { scanning: true, symbolCount: 100 },
        'FOREX':  { scanning: true, symbolCount: 50 },
        'NYSE':   { scanning: true, symbolCount: 200 },
        'NASDAQ': { scanning: true, symbolCount: 200 }
      };
    }

    function generateSampleExchangeData() { exchanges = sampleExchanges(); }

    function generateSampleScanData() {
      const { mode, rsiType, useMACD, useVOL, useATR } = getControls();

      const base = [
        {symbol:'BTC/USD', exchange:'CRYPTO'},
        {symbol:'ETH/USD', exchange:'CRYPTO'},
        {symbol:'AAPL', exchange:'ALPACA'},
        {symbol:'TSLA', exchange:'ALPACA'},
        {symbol:'NVDA', exchange:'ALPACA'},
        {symbol:'SPY', exchange:'NYSE'},
        {symbol:'QQQ', exchange:'NASDAQ'},
        {symbol:'MSFT', exchange:'NASDAQ'},
        {symbol:'AMZN', exchange:'NASDAQ'},
        {symbol:'GOOGL', exchange:'ALPACA'},
        {symbol:'META', exchange:'NASDAQ'},
        {symbol:'NFLX', exchange:'ALPACA'},
        {symbol:'AMD', exchange:'NASDAQ'},
        {symbol:'INTC', exchange:'NASDAQ'}
      ];

      const modeBias = {aggressive: 0.55, balanced: 0.35, conservative: 0.2}; // higher => more signals
      const bias = modeBias[mode] || 0.35;

      scanData = base.map(({symbol, exchange}) => {
        // price/change
        const price = (Math.random()*500 + 50);
        const change = ((Math.random()-0.5)*10);

        // RSIReal vs Wilder
        const rsiReal = (Math.random()*100);
        const rsiWilder = (Math.random()*100);
        const rsiVal = rsiType === 'real' ? rsiReal : rsiWilder;
        const rsiColor = rsiVal < 30 ? 'text-green-400 font-bold' : (rsiVal > 70 ? 'text-red-400 font-bold' : '');

        // MACD dummy
        const macd = (Math.random()-0.5)*2;

        // Volume / ATR gates (optional, make loose)
        const volPass = !useVOL || Math.random() > 0.25;
        const atrPass = !useATR || Math.random() > 0.25;
        const macdPass = !useMACD || Math.random() > 0.35;

        // Signal probability influenced by mode + RSI
        let signal = 'NEUTRAL';
        if (volPass && atrPass && macdPass) {
          if (rsiType === 'real') {
            if (rsiVal < 32 && Math.random() < bias) signal = 'BUY';
            else if (rsiVal > 68 && Math.random() < bias) signal = 'SELL';
          } else {
            if (rsiVal < 30 && Math.random() < bias*0.9) signal = 'BUY';
            else if (rsiVal > 70 && Math.random() < bias*0.9) signal = 'SELL';
          }
        }

        const qty = exchange === 'CRYPTO' ? 0.01 : 10;

        return {
          symbol, exchange,
          price: price.toFixed(2),
          change: change.toFixed(2),
          volume: Math.floor(Math.random()*1_000_000).toLocaleString(),
          rsi: rsiVal.toFixed(1),
          rsiColor,
          macd,
          signal,
          quantity: qty
        };
      });
    }

    function generateSampleTickerData() {
      const syms = [
        {symbol: 'BTC/USD', exchange: 'CRYPTO'},{symbol:'ETH/USD',exchange:'CRYPTO'},
        {symbol: 'AAPL', exchange: 'ALPACA'}, {symbol:'TSLA', exchange:'ALPACA'},
        {symbol: 'NVDA', exchange: 'ALPACA'}, {symbol:'SPY', exchange:'NYSE'},
        {symbol: 'QQQ', exchange: 'NASDAQ'},{symbol:'MSFT',exchange:'NASDAQ'},
        {symbol: 'AMZN', exchange: 'NASDAQ'},{symbol:'GOOGL',exchange:'ALPACA'}
      ];
      tickerItems = syms.map(({symbol,exchange}) => ({
        symbol, exchange,
        price: (Math.random()*500+50).toFixed(2),
        change: ((Math.random()-0.5)*10).toFixed(2),
        signal: Math.random()>0.6 ? (Math.random()>0.5?'BUY':'SELL') : 'NEUTRAL'
      }));
    }

    // ----------------- Popup flow -----------------
    function openTradePopupForSignal(row) {
      // set active broker/symbol
      activeTradeSymbol = row.symbol;
      activeTradeExchange = row.exchange;
      updateScanResultsDisplay();
      updateExchangeStatusDisplay();
      updateTickerDisplay();

      const side = row.signal === 'SELL' ? 'SELL' : 'BUY';

      const params = new URLSearchParams({
        symbol: row.symbol,
        exchange: row.exchange,
        side,
        qty: row.quantity || 1,
        price: row.price,
        change: row.change,
        rsi: row.rsi,
        signal: row.signal,
        reason: `Scanner detected ${row.signal} - RSI:${row.rsi}, Vol:${row.volume}`
      });

      // expand url for full view
      const expandUrl = `/trade-full?symbol=${encodeURIComponent(row.symbol)}&exchange=${encodeURIComponent(row.exchange)}&qty=${row.quantity||1}&side=${side}`;
      params.set('expand_url', expandUrl);

      window.open(`/trade-popup-fixed?${params.toString()}`,
        'TradeWindow_'+row.symbol.replace(/[^a-z0-9]/ig,''),
        'width=520,height=70,scrollbars=no,resizable=yes');
    }

    let openedPopups = new Set();
    let lastPopupTime = 0;

    function checkAndOpenPopups() {
      const now = Date.now();
      const testRow = scanData[testingRowIndex];
      if (!testRow) return;

      // throttle
      if (now - lastPopupTime < 15000) return;

      // broker busy? skip same broker
      if (activeTradeExchange && testRow.exchange === activeTradeExchange) return;

      if ((testRow.signal === 'BUY' || testRow.signal === 'SELL') && !openedPopups.has(testRow.symbol)) {
        openTradePopupForSignal(testRow);
        openedPopups.add(testRow.symbol);
        lastPopupTime = now;
        setTimeout(() => openedPopups.delete(testRow.symbol), 120000);
      }
    }

    function openTradePopupTestStock() {
      openTradePopupForSignal({
        symbol:'AAPL', exchange:'ALPACA', signal:'BUY', quantity:10,
        price:'175.50', change:'+0.8', rsi:'55.0', volume:'1000000'
      });
    }
    function openTradePopupTestCrypto() {
      openTradePopupForSignal({
        symbol:'BTC/USD', exchange:'CRYPTO', signal:'BUY', quantity:0.01,
        price:'43250.00', change:'+0.5', rsi:'58.5', volume:'500000'
      });
    }

    // listen for micro popup close
    window.addEventListener('message', (event) => {
      const d = event.data || {};
      if (d.type === 'TRADE_CLOSED') {
        // free broker & symbol
        activeTradeSymbol = null;
        activeTradeExchange = null;
        updateExchangeStatusDisplay();
        updateScanResultsDisplay();
        updateTickerDisplay();

        // backend notify is done inside popup; nothing else here
      }
    });

    // ----------------- Start -----------------
    init();
  </script>
</body>
</html>
